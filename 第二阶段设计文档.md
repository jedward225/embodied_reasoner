# ç¬¬äºŒé˜¶æ®µï¼šç²¾ç»†åŒ–æ„ŸçŸ¥æ¨¡å—è®¾è®¡æ–‡æ¡£

## ğŸ¯ **é˜¶æ®µç›®æ ‡**
è§£å†³**å¤§å‹ç‰©ä½“äº¤äº’ç²¾åº¦ä¸è¶³**é—®é¢˜ï¼Œå®ç°è¯­ä¹‰åŒ–ç²¾ç¡®å®šä½ï¼Œæ”¯æŒ"æ²™å‘å³ä¾§æ‰¶æ‰‹"ã€"æ¡Œå­è¾¹ç¼˜"ç­‰ç²¾ç»†åŒ–æŒ‡ä»¤ã€‚

---

## ğŸ—ï¸ **æŠ€æœ¯æ¶æ„è®¾è®¡**

### æ ¸å¿ƒæ¨¡å—åˆ’åˆ†

```mermaid
graph TD
    A[ç”¨æˆ·æŒ‡ä»¤: "æŠŠæ¯å­æ”¾åœ¨æ²™å‘å³æ‰¶æ‰‹ä¸Š"] --> B[è¯­ä¹‰è§£æå™¨]
    B --> C[ç©ºé—´ç­¾åç³»ç»Ÿ SpatialSignature]
    C --> D[6Dä½å§¿ä¼°è®¡å™¨]
    C --> E[ç‚¹äº‘å¤„ç†å™¨]
    D --> F[ç²¾ç¡®äº¤äº’ç‚¹è®¡ç®—]
    E --> F
    F --> G[BaseAgentå¢å¼ºå®šä½]
    G --> H[AI2THORç²¾ç¡®æ“ä½œ]
    
    I[AI2THORæ·±åº¦å›¾] --> E
    I --> J[å®ä¾‹åˆ†å‰²æ©ç ]
    J --> E
```

### æ•°æ®æµè®¾è®¡

1. **æ„ŸçŸ¥æ•°æ®è·å–**
   ```
   AI2THOR Event â†’ æ·±åº¦å›¾ + å®ä¾‹åˆ†å‰² â†’ ç‚¹äº‘é‡å»º â†’ ç‰©ä½“6Dä½å§¿
   ```

2. **ç©ºé—´è¯­ä¹‰ç†è§£**
   ```
   è¯­ä¹‰æŒ‡ä»¤ â†’ ç©ºé—´å…³ç³»è§£æ â†’ åŒºåŸŸå®šä½ â†’ ç²¾ç¡®äº¤äº’ç‚¹
   ```

3. **åŠ¨ä½œæ‰§è¡Œä¼˜åŒ–**
   ```
   äº¤äº’ç‚¹ â†’ æœ€ä¼˜è§†è§’è®¡ç®— â†’ è·¯å¾„è§„åˆ’ â†’ ç²¾ç¡®å¯¼èˆªæ‰§è¡Œ
   ```

---

## ğŸ“Š **æ ¸å¿ƒæ•°æ®ç»“æ„**

### SpatialSignature ç±»è®¾è®¡

```python
@dataclass
class SpatialSignature:
    """ç‰©ä½“çš„ç©ºé—´ç­¾åï¼ŒåŒ…å«ç²¾ç»†åŒ–å‡ ä½•å’Œè¯­ä¹‰ä¿¡æ¯"""
    
    # åŸºç¡€ä¿¡æ¯
    object_id: str
    object_type: str
    bounding_box: Dict  # AI2THORåŸå§‹è¾¹ç•Œæ¡†
    
    # ç‚¹äº‘æ•°æ®
    point_cloud: np.ndarray  # (N, 3) 3Dç‚¹äº‘
    point_colors: np.ndarray  # (N, 3) RGBé¢œè‰²
    
    # 6Dä½å§¿
    position: np.ndarray  # (3,) ä¸­å¿ƒä½ç½®
    orientation: np.ndarray  # (3, 3) æ—‹è½¬çŸ©é˜µ
    principal_axes: np.ndarray  # (3, 3) ä¸»æˆåˆ†æ–¹å‘
    
    # è¯­ä¹‰åŒºåŸŸ
    semantic_regions: Dict[str, RegionSignature]
    # ä¾‹å¦‚: {"left_arm": RegionSignature, "right_arm": RegionSignature}
    
    # äº¤äº’èƒ½åŠ›
    affordances: List[AffordancePoint]
    surface_normals: np.ndarray  # è¡¨é¢æ³•å‘é‡
    
    # ç©ºé—´å…³ç³»
    spatial_relations: Dict[str, Any]  # ä¸å…¶ä»–ç‰©ä½“çš„ç©ºé—´å…³ç³»
```

### RegionSignature å­åŒºåŸŸè®¾è®¡

```python
@dataclass 
class RegionSignature:
    """ç‰©ä½“ç‰¹å®šåŒºåŸŸçš„ç©ºé—´ç­¾å"""
    
    region_name: str  # "left_arm", "right_arm", "back", "seat"
    point_indices: np.ndarray  # å±äºè¯¥åŒºåŸŸçš„ç‚¹äº‘ç´¢å¼•
    center: np.ndarray  # åŒºåŸŸä¸­å¿ƒ
    normal: np.ndarray  # åŒºåŸŸä¸»æ³•å‘é‡
    extent: np.ndarray  # åŒºåŸŸå°ºå¯¸ (é•¿å®½é«˜)
    
    # äº¤äº’ç‰¹æ€§
    accessibility: float  # å¯è®¿é—®æ€§å¾—åˆ† [0,1]
    stability: float     # æ”¾ç½®ç¨³å®šæ€§å¾—åˆ† [0,1]
    surface_quality: float  # è¡¨é¢è´¨é‡å¾—åˆ† [0,1]
```

### AffordancePoint äº¤äº’ç‚¹è®¾è®¡

```python
@dataclass
class AffordancePoint:
    """ç‰©ä½“ä¸Šçš„å¯äº¤äº’ç‚¹"""
    
    position: np.ndarray  # 3Dåæ ‡
    normal: np.ndarray   # è¡¨é¢æ³•å‘é‡
    interaction_type: str  # "pickup", "place", "press", "grasp"
    confidence: float    # ç½®ä¿¡åº¦ [0,1]
    approach_direction: np.ndarray  # æ¨èæ¥è¿‘æ–¹å‘
```

---

## ğŸ”§ **ç®—æ³•è®¾è®¡**

### 1. ç‚¹äº‘é‡å»ºç®—æ³•

```python
class PointCloudReconstructor:
    """ä»AI2THORæ·±åº¦å›¾é‡å»ºç‚¹äº‘"""
    
    def reconstruct_pointcloud(self, 
                              depth_image: np.ndarray,
                              rgb_image: np.ndarray, 
                              instance_mask: np.ndarray,
                              camera_intrinsics: Dict) -> np.ndarray:
        """
        è¾“å…¥: æ·±åº¦å›¾ + RGBå›¾ + å®ä¾‹åˆ†å‰²æ©ç  + ç›¸æœºå†…å‚
        è¾“å‡º: å½©è‰²ç‚¹äº‘ (N, 6) [x,y,z,r,g,b]
        """
        pass
```

### 2. 6Dä½å§¿ä¼°è®¡ç®—æ³•

```python
class PoseEstimator:
    """åŸºäºç‚¹äº‘çš„6Dä½å§¿ä¼°è®¡"""
    
    def estimate_6d_pose(self, point_cloud: np.ndarray) -> Tuple[np.ndarray, np.ndarray]:
        """
        ä½¿ç”¨PCAåˆ†æç‰©ä½“çš„ä¸»è¦æ–¹å‘å’Œä½ç½®
        è¿”å›: (position, rotation_matrix)
        """
        # PCAä¸»æˆåˆ†åˆ†æ
        pca = PCA(n_components=3)
        pca.fit(point_cloud)
        
        # è®¡ç®—ä¸»è½´æ–¹å‘
        principal_axes = pca.components_
        
        # å¤„ç†æ–¹å‘ä¸€è‡´æ€§
        # ...
        
        return center, rotation_matrix
```

### 3. è¯­ä¹‰åŒºåŸŸåˆ†å‰²ç®—æ³•

```python
class SemanticRegionSegmenter:
    """åŸºäºå‡ ä½•ç‰¹å¾çš„è¯­ä¹‰åŒºåŸŸåˆ†å‰²"""
    
    def segment_sofa_regions(self, signature: SpatialSignature) -> Dict[str, RegionSignature]:
        """æ²™å‘åŒºåŸŸåˆ†å‰²: åº§ä½ã€é èƒŒã€å·¦æ‰¶æ‰‹ã€å³æ‰¶æ‰‹"""
        
        # åŸºäºä¸»æˆåˆ†æ–¹å‘è¿›è¡Œå‡ ä½•åˆ†å‰²
        # 1. è¯†åˆ«åº§ä½åŒºåŸŸ(æœ€ä½+æœ€å¤§å¹³é¢)
        # 2. è¯†åˆ«é èƒŒåŒºåŸŸ(å‚ç›´é¢ï¼Œåº§ä½åæ–¹)  
        # 3. è¯†åˆ«æ‰¶æ‰‹åŒºåŸŸ(åº§ä½ä¸¤ä¾§çš„å‚ç›´ç»“æ„)
        
        regions = {}
        
        # åº§ä½æ£€æµ‹ç®—æ³•
        seat_region = self._detect_seat_region(signature)
        regions["seat"] = seat_region
        
        # æ‰¶æ‰‹æ£€æµ‹ç®—æ³• 
        left_arm, right_arm = self._detect_arm_regions(signature, seat_region)
        regions["left_arm"] = left_arm
        regions["right_arm"] = right_arm
        
        # é èƒŒæ£€æµ‹ç®—æ³•
        back_region = self._detect_back_region(signature, seat_region)
        regions["back"] = back_region
        
        return regions
```

### 4. ç²¾ç¡®äº¤äº’ç‚¹è®¡ç®—

```python
class InteractionPointCalculator:
    """è®¡ç®—æœ€ä¼˜äº¤äº’ç‚¹"""
    
    def calculate_placement_point(self, 
                                 target_region: RegionSignature,
                                 object_to_place: SpatialSignature) -> AffordancePoint:
        """
        è®¡ç®—åœ¨ç›®æ ‡åŒºåŸŸæ”¾ç½®ç‰©ä½“çš„æœ€ä¼˜ç‚¹
        è€ƒè™‘å› ç´ : ç¨³å®šæ€§ã€å¯è¾¾æ€§ã€ç¢°æ’é¿å…
        """
        
        # ç¨³å®šæ€§åˆ†æ
        stability_score = self._analyze_stability(target_region, object_to_place)
        
        # å¯è¾¾æ€§åˆ†æ  
        accessibility_score = self._analyze_accessibility(target_region)
        
        # ç»¼åˆè¯„åˆ†é€‰æ‹©æœ€ä¼˜ç‚¹
        best_point = self._select_optimal_point(target_region, stability_score, accessibility_score)
        
        return AffordancePoint(
            position=best_point,
            normal=target_region.normal,
            interaction_type="place",
            confidence=max(stability_score, accessibility_score)
        )
```

---

## ğŸ® **é›†æˆæ–¹æ¡ˆ**

### BaseAgent å¢å¼º

```python
class EnhancedBaseAgent(BaseAgent):
    """å¢å¼ºçš„BaseAgentï¼Œæ”¯æŒç²¾ç»†åŒ–å®šä½"""
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.spatial_perception = SpatialPerceptionModule()
        self.semantic_parser = SemanticParser()
    
    def navigate_to_precise_location(self, instruction: str) -> bool:
        """
        ç²¾ç¡®å¯¼èˆªåˆ°è¯­ä¹‰æŒ‡å®šä½ç½®
        ä¾‹å¦‚: "navigate to the right arm of the sofa"
        """
        
        # è§£æè¯­ä¹‰æŒ‡ä»¤
        target_object, target_region = self.semantic_parser.parse(instruction)
        
        # è·å–ç‰©ä½“çš„ç©ºé—´ç­¾å
        signature = self.spatial_perception.get_spatial_signature(target_object)
        
        # è®¡ç®—æœ€ä¼˜äº¤äº’ç‚¹
        interaction_point = signature.semantic_regions[target_region].center
        
        # ä½¿ç”¨å¢å¼ºçš„å®šä½ç®—æ³•å¯¼èˆª
        return self._navigate_to_3d_point(interaction_point)
```

### å‘åå…¼å®¹æ€§

```python
# ä¿æŒåŸæœ‰APIçš„å…¼å®¹æ€§
def calculate_best_view_angles(self, item):
    """å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒç²¾ç»†åŒ–å®šä½"""
    
    # å°è¯•ä½¿ç”¨ç²¾ç»†åŒ–æ„ŸçŸ¥
    if hasattr(self, 'spatial_perception'):
        signature = self.spatial_perception.get_spatial_signature(item["objectId"])
        if signature:
            return self._calculate_precise_view_angles(signature)
    
    # å›é€€åˆ°åŸå§‹ç®—æ³•
    return self._original_calculate_best_view_angles(item)
```

---

## ğŸ“‹ **å®ç°è®¡åˆ’**

### ç¬¬ä¸€å‘¨ï¼šåŸºç¡€æ•°æ®ç»“æ„
- [ ] å®ç° `SpatialSignature` ç±»
- [ ] å®ç° `RegionSignature` ç±»  
- [ ] å®ç° `AffordancePoint` ç±»
- [ ] ç¼–å†™åŸºç¡€æµ‹è¯•ç”¨ä¾‹

### ç¬¬äºŒå‘¨ï¼šç‚¹äº‘å¤„ç†
- [ ] å®ç° `PointCloudReconstructor`
- [ ] å®ç° `PoseEstimator` (PCA-based)
- [ ] AI2THORæ·±åº¦å›¾é›†æˆæµ‹è¯•
- [ ] ç›¸æœºå†…å‚æ ‡å®š

### ç¬¬ä¸‰å‘¨ï¼šè¯­ä¹‰åˆ†å‰²
- [ ] å®ç° `SemanticRegionSegmenter`
- [ ] æ²™å‘åŒºåŸŸåˆ†å‰²ç®—æ³•
- [ ] æ¡Œå­åŒºåŸŸåˆ†å‰²ç®—æ³•
- [ ] è¯­ä¹‰åˆ†å‰²å‡†ç¡®æ€§éªŒè¯

### ç¬¬å››å‘¨ï¼šé›†æˆä¼˜åŒ–
- [ ] `EnhancedBaseAgent` å®ç°
- [ ] ç²¾ç¡®äº¤äº’ç‚¹è®¡ç®—
- [ ] æ€§èƒ½ä¼˜åŒ–ä¸æµ‹è¯•
- [ ] å®Œæ•´åŠŸèƒ½éªŒè¯

---

## ğŸ¯ **æˆåŠŸæŒ‡æ ‡**

### åŠŸèƒ½æŒ‡æ ‡
- [ ] æ”¯æŒ 5+ ç§å¤§å‹ç‰©ä½“çš„ç²¾ç»†åŒ–åŒºåŸŸè¯†åˆ«
- [ ] ç²¾ç¡®å®šä½è¯¯å·® < 10cm  
- [ ] è¯­ä¹‰æŒ‡ä»¤è§£æå‡†ç¡®ç‡ > 90%
- [ ] ç³»ç»Ÿå“åº”æ—¶é—´ < 2ç§’

### æµ‹è¯•åœºæ™¯
- [ ] "æŠŠæ¯å­æ”¾åœ¨æ²™å‘çš„å³æ‰¶æ‰‹ä¸Š"
- [ ] "æŠŠä¹¦æ”¾åœ¨æ¡Œå­çš„å·¦è¾¹ç¼˜"  
- [ ] "æ‰“å¼€æŸœå­çš„ä¸Šå±‚é—¨"
- [ ] "æŠŠç‰©å“æ”¾åœ¨æ¤…å­çš„åº§ä½ä¸­å¤®"

---

## ğŸ”„ **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**

ç°åœ¨å¼€å§‹ç¬¬ä¸€å‘¨çš„å·¥ä½œï¼š**åŸºç¡€æ•°æ®ç»“æ„å®ç°**ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹æ„å»º `SpatialSignature` ç±»ï¼ 